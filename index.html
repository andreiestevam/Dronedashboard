<script src="https://www.youtube.com/iframe_api"></script>
<script>
window.addEventListener('DOMContentLoaded', () => {
  const qs=(s,e=document)=>e.querySelector(s);
  const params=new URLSearchParams(location.search);
  const cfgUrl=params.get('cfg'); const refreshSec=parseInt(params.get('refresh')||'0',10);
  const MODE=(params.get('mode')||'edit').toLowerCase(); const isView=MODE==='view';
  let VIDEO_IDS=[]; let LABELS=[]; let LOCS=[]; let COLS=parseInt(params.get('cols')||'4',10);
  let YT_READY=false;

  // Util
  function escapeHtml(str){
    const map = {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;'};
    return String(str).replace(/[&<>"']/g, s => map[s]);
  }
  function getParamArray(name){ const raw=params.get(name); if(!raw) return []; return raw.split(',').map(decodeURIComponent).map(s=>s.trim()).filter(Boolean); }
  function setParamArray(name,arr){ if(!arr||!arr.length){ params.delete(name); return; } params.set(name, arr.map(encodeURIComponent).join(',')); }
  function updateURL(){ const url=location.pathname+'?'+params.toString(); history.replaceState({},'',url); }
  function youtubeIdFromUrl(url){
    try{
      if(url.includes('watch?v=')) return url.split('v=')[1].split('&')[0];
      if(url.includes('youtu.be/')) return url.split('youtu.be/')[1].split('?')[0];
    }catch(_){}
    return url.trim();
  }

  // Tela cheia
  const fsBtn = qs('#btnFullscreen'); if(fsBtn){ fsBtn.addEventListener('click', () => {
    if (!document.fullscreenElement) document.documentElement.requestFullscreen();
    else document.exitFullscreen();
  });}

  // Esconde controles no modo visualizador
  if(isView){
    ['#btnShare','#btnConfig','#btnExport','#labels','#ids','#apply','#clear','#helperText']
      .forEach(sel => { const el=qs(sel); if(el) el.classList.add('hidden-view'); });
  }

  // Estado inicial
  VIDEO_IDS=getParamArray('ids');
  LABELS=getParamArray('labels');
  LOCS=getParamArray('locs');
  if(!isView){
    const idsEl=qs('#ids'), labEl=qs('#labels');
    if(idsEl) idsEl.value=VIDEO_IDS.join(', ');
    if(labEl) labEl.value=LABELS.join(', ');
  }
  qs('#layout').value=String(COLS);

  // Carrega config remota (para view e edit)
  async function loadRemoteConfig(){
    if(!cfgUrl) return;
    try{
      const res=await fetch(cfgUrl+(cfgUrl.includes('?')?'&':'?')+'_='+(Date.now()));
      if(!res.ok) throw new Error('HTTP '+res.status);
      const json=await res.json();
      VIDEO_IDS=json.ids||[]; LABELS=json.labels||[]; LOCS=json.locs||[]; COLS=Number(json.cols||COLS||4);
      if(!isView){
        const idsEl=qs('#ids'), labEl=qs('#labels');
        if(idsEl) idsEl.value=VIDEO_IDS.join(', ');
        if(labEl) labEl.value=LABELS.join(', ');
      }
      qs('#layout').value=String(COLS);
      renderGrid();
    }catch(e){ console.error('Falha ao carregar config remota:', e); }
  }
  if(cfgUrl){ loadRemoteConfig(); if(refreshSec>0) setInterval(loadRemoteConfig, Math.max(5000,refreshSec*1000)); }

  // YouTube API
  window.onYouTubeIframeAPIReady=function(){ YT_READY=true; renderGrid(); };

  // Render
  function renderGrid(){
    const grid=qs('#gridContainer');
    grid.style.gridTemplateColumns=`repeat(${parseInt(qs('#layout').value,10)}, 1fr)`;
    grid.innerHTML='';
    if(!VIDEO_IDS.length){
      grid.innerHTML = isView ? 'Aguardando configuração do operador.' : 'Clique em <b>Inserir Equipe</b> ou use <b>Aplicar</b>.';
      return;
    }
    VIDEO_IDS.forEach((id, idx)=>{
      const name=LABELS[idx]||`Equipe ${idx+1}`;
      const loc=LOCS[idx]||'';
      const card=document.createElement('div'); card.className='video-card';
      card.innerHTML=`
        <div class="relative video-box">
          <div id="yt_${idx}" class="player-fill"></div>
          <div class="absolute top-2 left-2 flex items-center gap-2">
            <span class="px-2 py-1 rounded text-[10px] badge-live flex items-center gap-1">
              <span class="w-2 h-2 bg-white rounded-full animate-pulse"></span> AO VIVO
            </span>
          </div>
          <div class="absolute top-2 right-2 flex items-center gap-2">
            <button class="tile-btn" onclick="window.open('https://www.youtube.com/watch?v=${encodeURIComponent(id)}','_blank')">Tela cheia</button>
          </div>
        </div>
        <div class="p-3 bg-gray-800/70">
          <h3 class="font-semibold">${escapeHtml(name)}</h3>
          <p class="text-gray-300 text-xs">${escapeHtml(loc)}</p>
        </div>`;
      grid.appendChild(card);

      if(YT_READY){
        new YT.Player(`yt_${idx}`, {
          videoId:id, width:'100%', height:'100%',
          playerVars:{autoplay:1, mute:1, playsinline:1, controls:0, rel:0, modestbranding:1},
          events:{ onReady:e=>{ try{e.target.mute(); e.target.playVideo();}catch(_){}} }
        });
      }
    });
  }
  if(!cfgUrl) renderGrid(); // se não houver config remota, desenha com o que tem

  // ------- Handlers do EDITOR -------
  if(!isView){
    // Aplicar
    const applyBtn=qs('#apply');
    if(applyBtn){ applyBtn.addEventListener('click', ()=>{
      VIDEO_IDS=(qs('#ids').value||'').split(',').map(s=>s.trim()).filter(Boolean);
      LABELS=(qs('#labels').value||'').split(',').map(s=>s.trim());
      COLS=parseInt(qs('#layout').value,10)||4;
      params.set('cols', COLS);
      setParamArray('ids', VIDEO_IDS);
      setParamArray('labels', LABELS);
      if(LOCS.length) setParamArray('locs', LOCS);
      updateURL();
      renderGrid();
    });}

    // Limpar
    const clearBtn=qs('#clear');
    if(clearBtn){ clearBtn.addEventListener('click', ()=>{
      VIDEO_IDS=[]; LABELS=[]; LOCS=[];
      const idsEl=qs('#ids'), labEl=qs('#labels');
      if(idsEl) idsEl.value=''; if(labEl) labEl.value='';
      ['ids','labels','locs'].forEach(k=>params.delete(k));
      updateURL(); renderGrid();
    });}

    // Exportar config
    const exportBtn=qs('#btnExport');
    if(exportBtn){ exportBtn.addEventListener('click', ()=>{
      const cfg={ ids: VIDEO_IDS.slice(), labels: LABELS.slice(), locs: LOCS.slice(), cols: parseInt(qs('#layout').value,10)||4 };
      const blob=new Blob([JSON.stringify(cfg,null,2)],{type:'application/json'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='config.json'; a.click();
    });}

    // Gerar Link (visualizador)
    const shareBtn=qs('#btnShare');
    if(shareBtn){ shareBtn.addEventListener('click', ()=>{
      const base=location.origin+location.pathname;
      const url=new URL(base);
      url.searchParams.set('cfg', cfgUrl || 'config.json');
      url.searchParams.set('refresh', refreshSec || 10);
      url.searchParams.set('mode', 'view');
      url.searchParams.set('cols', qs('#layout').value);
      navigator.clipboard.writeText(url.toString()).then(()=>alert('Link de visualização copiado:\n\n'+url.toString()));
    });}

    // Adicionar equipe (modal)
    const addBtn=qs('#btnAddTeam');
    if(addBtn){ addBtn.addEventListener('click', e=>{
      e.preventDefault();
      const name=qs('#teamName').value.trim();
      const loc=qs('#teamLocation').value.trim();
      const url=qs('#youtubeUrl').value.trim();
      if(!name || !url){ alert('Preencha Nome da Equipe e URL do YouTube.'); return; }
      const id=youtubeIdFromUrl(url);

      VIDEO_IDS.push(id); LABELS.push(name); LOCS.push(loc);

      // Sincroniza inputs/URL para facilitar exportar e compartilhar
      const idsEl=qs('#ids'), labEl=qs('#labels');
      if(idsEl) idsEl.value=VIDEO_IDS.join(', ');
      if(labEl) labEl.value=LABELS.join(', ');
      params.set('cols', qs('#layout').value);
      setParamArray('ids', VIDEO_IDS);
      setParamArray('labels', LABELS);
      setParamArray('locs', LOCS);
      updateURL();

      renderGrid();
      document.getElementById('configModal').classList.add('hidden');
      document.getElementById('teamForm').reset();
    });}
  }

  // Layout (ambos os modos)
  const layoutEl=qs('#layout');
  if(layoutEl){ layoutEl.addEventListener('change', ()=>{ params.set('cols', qs('#layout').value); updateURL(); renderGrid(); }); }
});
</script>

