<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard Programa de Policiamento com Drones</title>
  <!-- build: v8l -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --card:#111827; }
    body { box-sizing: border-box; }
    .grid-container { display:grid; grid-template-columns:repeat(4,1fr); gap:1rem; }
    @media (max-width:1400px){ .grid-container{ grid-template-columns:repeat(3,1fr);} }
    @media (max-width:1024px){ .grid-container{ grid-template-columns:repeat(2,1fr);} }
    @media (max-width:640px){ .grid-container{ grid-template-columns:1fr;} }
    .video-card{ background:var(--card); border:1px solid #374151; border-radius:12px; overflow:hidden; }
    .video-box{ aspect-ratio:16/9; position:relative; background:#0b1220; cursor:move; }
    .player-fill{ position:absolute; inset:0; }
    .player-fill iframe{ width:100%!important; height:100%!important; display:block; }
    .badge-live{ background:#dc2626; }
    .tile-btn{ font-size:12px; padding:4px 8px; border:1px solid rgba(255,255,255,.15); border-radius:8px; }
    .tile-btn:hover{ background:rgba(255,255,255,.08); }
    .hidden-view{ display:none!important; }
    .drag-over{ outline:2px dashed #60a5fa; outline-offset:-6px; }
  </style>
  <script src="https://www.youtube.com/iframe_api"></script>

  <script defer>
  (function(){
    const qs=(s,e=document)=>e.querySelector(s);

    /* ===== Login universal ===== */
    const AUTH_USER='OPERACAOCPM', AUTH_PASS='CAVPMDRONES', REMEMBER_MINUTES=240;
    function auth_ok_until(){ const v=localStorage.getItem('auth_ok_until'); return v?parseInt(v,10):0; }
    function set_auth_ok(){ if(REMEMBER_MINUTES>0){ localStorage.setItem('auth_ok_until', String(Date.now()+REMEMBER_MINUTES*60*1000)); } }
    function doLogin(){
      const u=qs('#authUser')?.value?.trim()||'', p=qs('#authPass')?.value||'', err=qs('#authErr');
      if(u===AUTH_USER&&p===AUTH_PASS){ set_auth_ok(); qs('#authOverlay').style.display='none'; return true; }
      err?.classList.remove('hidden'); setTimeout(()=>err?.classList.add('hidden'),2000); return false;
    }
    document.addEventListener('DOMContentLoaded', ()=>{
      if(auth_ok_until()>Date.now()) qs('#authOverlay').style.display='none';
      qs('#authForm')?.addEventListener('submit', e=>{ e.preventDefault(); doLogin(); });
    });
    /* ========================== */

    // Estado & parâmetros
    const params=new URLSearchParams(location.search);
    const cfgUrl=params.get('cfg'); const refreshSec=parseInt(params.get('refresh')||'0',10);
    const MODE=(params.get('mode')||'edit').toLowerCase(); const isView=MODE==='view';
    let COLS=parseInt(params.get('cols')||'2',10);
    let VIDEO_IDS=[], LABELS=[], LOCS=[];
    let YT_READY=false;

    // helpers
    function escapeHtml(str){ const map={'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}; return String(str).replace(/[&<>"']/g,s=>map[s]); }
    function getParamArray(name){ const raw=params.get(name); if(!raw) return []; return raw.split(',').map(decodeURIComponent).map(s=>s.trim()).filter(Boolean); }
    function setParamArray(name,arr){ if(!arr||!arr.length){ params.delete(name); return; } params.set(name, arr.map(encodeURIComponent).join(',')); }
    function updateURL(){ history.replaceState({},'',location.pathname+'?'+params.toString()); }
    function youtubeIdFromUrl(url){ try{ if(url.includes('watch?v=')) return url.split('v=')[1].split('&')[0]; if(url.includes('youtu.be/')) return url.split('youtu.be/')[1].split('?')[0]; }catch(_){} return url.trim(); }

    // drag & drop (editor)
    let dragSrcIndex=null;
    function attachDnD(cardEl, index){
      if(isView) return;
      cardEl.setAttribute('draggable','true');
      cardEl.addEventListener('dragstart', e=>{ dragSrcIndex=index; e.dataTransfer.effectAllowed='move'; cardEl.classList.add('opacity-80'); });
      cardEl.addEventListener('dragend',   ()=>{ cardEl.classList.remove('opacity-80'); document.querySelectorAll('.drag-over').forEach(x=>x.classList.remove('drag-over')); });
      cardEl.addEventListener('dragover',  e=>{ e.preventDefault(); e.dataTransfer.dropEffect='move'; cardEl.classList.add('drag-over'); });
      cardEl.addEventListener('dragleave', ()=>{ cardEl.classList.remove('drag-over'); });
      cardEl.addEventListener('drop',      e=>{
        e.preventDefault();
        cardEl.classList.remove('drag-over');
        const targetIndex=parseInt(cardEl.dataset.idx,10);
        if(dragSrcIndex===null || dragSrcIndex===targetIndex) return;
        // reordena arrays
        function moveInArray(arr, from, to){ const x=arr.splice(from,1)[0]; arr.splice(to,0,x); }
        moveInArray(VIDEO_IDS, dragSrcIndex, targetIndex);
        moveInArray(LABELS,    dragSrcIndex, targetIndex);
        moveInArray(LOCS,      dragSrcIndex, targetIndex);
        // sincroniza UI/URL
        if(!isView){
          qs('#ids').value=VIDEO_IDS.join(', ');
          qs('#labels').value=LABELS.join(', ');
          setParamArray('ids', VIDEO_IDS); setParamArray('labels', LABELS); setParamArray('locs', LOCS);
          params.set('cols', qs('#layout').value||'2'); updateURL();
        }
        renderGrid(); // re-render editor (rápido)
      });
    }

    // renderização
    window.onYouTubeIframeAPIReady=function(){ YT_READY=true; renderGrid(); };

    function renderGrid(){
      const grid=qs('#gridContainer'), layout=qs('#layout'); if(!grid||!layout) return;
      grid.style.gridTemplateColumns=`repeat(${parseInt(layout.value,10)}, 1fr)`; grid.innerHTML='';
      if(LABELS.length<VIDEO_IDS.length){ for(let i=LABELS.length;i<VIDEO_IDS.length;i++) LABELS[i]=`Equipe ${String(i+1).padStart(2,'0')}`; }
      if(LOCS.length<VIDEO_IDS.length){ for(let i=LOCS.length;i<VIDEO_IDS.length;i++) LOCS[i]=''; }
      if(!VIDEO_IDS.length){ grid.innerHTML=isView?'Aguardando configuração do operador.':'Clique em <b>Inserir Equipe</b>'; return; }

      VIDEO_IDS.forEach((id,idx)=>{
        const name=LABELS[idx]||`Equipe ${idx+1}`, loc=LOCS[idx]||'';
        const card=document.createElement('div'); card.className='video-card'; card.id=`card_${id}`; card.dataset.idx=idx;
        card.innerHTML =
          '<div class="relative video-box">'+
            `<div id="yt_${idx}" class="player-fill"></div>`+
            '<div class="absolute top-2 left-2 flex items-center gap-2">'+
              '<span class="px-2 py-1 rounded text-[10px] badge-live flex items-center gap-1">'+
                '<span class="w-2 h-2 bg-white rounded-full animate-pulse"></span> AO VIVO'+
              '</span>'+
            '</div>'+
            '<div class="absolute top-2 right-2 flex items-center gap-2">'+
              `<button class="tile-btn" onclick="window.open('https://www.youtube.com/watch?v=${encodeURIComponent(id)}','_blank')">Tela cheia</button>`+
            '</div>'+
          '</div>'+
          '<div class="px-2 pt-1 pb-0 bg-gray-800/70">'+
            `<h3 class="font-medium text-sm">${escapeHtml(name)}</h3>`+
            `<p class="text-gray-400 text-[11px]">${escapeHtml(loc)}</p>`+
          '</div>';
        grid.appendChild(card);
        attachDnD(card, idx);

        if(YT_READY){
          new YT.Player(`yt_${idx}`,{
            videoId:id, width:'100%', height:'100%',
            playerVars:{autoplay:1, mute:1, playsinline:1, controls:0, rel:0, modestbranding:1},
            events:{ onReady:e=>{ try{e.target.mute(); e.target.playVideo();}catch(_){ } } }
          });
        }
      });
    }

    // VISUALIZADOR: reordenar sem reiniciar vídeos (quando só muda a ordem)
    async function loadRemoteAndMaybeReorder(){
      if(!cfgUrl) return;
      try{
        const res=await fetch(cfgUrl+(cfgUrl.includes('?')?'&':'?')+'_='+(Date.now()));
        if(!res.ok) throw new Error('HTTP '+res.status);
        const j=await res.json();
        const newIds=j.ids||[], newLabels=j.labels||[], newLocs=j.locs||[];
        const sameSet = newIds.length===VIDEO_IDS.length &&
                        [...newIds].sort().join(',') === [...VIDEO_IDS].sort().join(',');
        if(sameSet && YT_READY){
          // só ordem mudou → reordenar DOM sem recriar players
          const grid=qs('#gridContainer');
          newIds.forEach(id=>{
            const el=document.getElementById(`card_${id}`);
            if(el) grid.appendChild(el);
          });
          // atualiza arrays em memória
          VIDEO_IDS = newIds.slice(); LABELS = newLabels.slice(); LOCS = newLocs.slice();
        } else {
          // adicionou/removeu → render completo
          VIDEO_IDS=newIds.slice(); LABELS=newLabels.slice(); LOCS=newLocs.slice();
          qs('#layout').value=String(j.cols||COLS||2);
          renderGrid();
        }
      }catch(e){ console.error('config remote:',e); }
    }

    // inicialização
    VIDEO_IDS=getParamArray('ids'); LABELS=getParamArray('labels'); LOCS=getParamArray('locs');
    document.addEventListener('DOMContentLoaded', ()=>{
      const layout=qs('#layout'); if(layout) layout.value=String(COLS);
      if(!isView){ qs('#ids').value=VIDEO_IDS.join(', '); qs('#labels').value=LABELS.join(', '); }
      if(isView){ ['#btnShare','#btnConfig','#btnExport','#labels','#ids','#apply','#clear','#helperText']
        .forEach(sel=>qs(sel)?.classList.add('hidden-view')); }
      qs('#btnFullscreen')?.addEventListener('click',()=>{ if(!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); });

      if(cfgUrl){
        // primeira carga
        loadRemoteAndMaybeReorder();
        if(refreshSec>0) setInterval(loadRemoteAndMaybeReorder, Math.max(3000, refreshSec*1000));
      } else {
        renderGrid();
      }
    });

    // editor: ações
    document.addEventListener('DOMContentLoaded', ()=>{
      if(isView) return;

      qs('#apply')?.addEventListener('click', ()=>{
        VIDEO_IDS=(qs('#ids').value||'').split(',').map(s=>s.trim()).filter(Boolean);
        LABELS=(qs('#labels').value||'').split(',').map(s=>s.trim());
        COLS=parseInt(qs('#layout').value,10)||2;
        params.set('cols', COLS);
        setParamArray('ids', VIDEO_IDS); setParamArray('labels', LABELS);
        if(LOCS.length) setParamArray('locs', LOCS);
        updateURL(); renderGrid();
      });

      qs('#clear')?.addEventListener('click', ()=>{
        VIDEO_IDS=[]; LABELS=[]; LOCS=[];
        qs('#ids').value=''; qs('#labels').value='';
        ['ids','labels','locs'].forEach(k=>params.delete(k));
        updateURL(); renderGrid();
      });

      qs('#btnExport')?.addEventListener('click', ()=>{
        const cfg={ ids:VIDEO_IDS, labels:LABELS, locs:LOCS, cols:parseInt(qs('#layout').value,10)||2 };
        const blob=new Blob([JSON.stringify(cfg,null,2)],{type:'application/json'});
        const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='config.json'; a.click();
      });

      qs('#btnShare')?.addEventListener('click', ()=>{
        const base=location.origin+location.pathname, url=new URL(base);
        url.searchParams.set('cfg', cfgUrl || 'config.json');
        url.searchParams.set('mode','view');
        url.searchParams.set('cols', qs('#layout').value || '2');
        // deixe o comandante com refresh para refletir reordenação:
        url.searchParams.set('refresh','10');
        navigator.clipboard.writeText(url.toString()).then(()=>alert('Link (visualizador) copiado:\n\n'+url.toString()));
      });

      qs('#btnAddTeam')?.addEventListener('click', (e)=>{
        e.preventDefault();
        const name=qs('#teamName').value.trim();
        const loc=qs('#teamLocation').value.trim();
        const url=qs('#youtubeUrl').value.trim();
        if(!name||!url){ alert('Preencha Nome e URL'); return; }
        const id=youtubeIdFromUrl(url);
        VIDEO_IDS.push(id); LABELS.push(name); LOCS.push(loc);
        qs('#ids').value=VIDEO_IDS.join(', '); qs('#labels').value=LABELS.join(', ');
        params.set('cols', qs('#layout').value||'2');
        setParamArray('ids', VIDEO_IDS); setParamArray('labels', LABELS); setParamArray('locs', LOCS);
        updateURL(); renderGrid();
        qs('#configModal').classList.add('hidden'); qs('#teamForm').reset();
      });

      qs('#layout')?.addEventListener('change', ()=>{ params.set('cols', qs('#layout').value); updateURL(); renderGrid(); });
    });

  })();
  </script>
</head>
<body class="bg-gray-900 text-white min-h-screen">

  <!-- Overlay de Login -->
  <div id="authOverlay" class="fixed inset-0 z-[1000] flex items-center justify-center bg-black/70">
    <div class="bg-gray-800 text-white w-full max-w-sm rounded-xl shadow-xl p-6">
      <h2 class="text-lg font-semibold mb-4">Acesso restrito</h2>
      <form id="authForm" class="space-y-3">
        <div>
          <label class="block text-sm mb-1">Usuário</label>
          <input id="authUser" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2" placeholder="usuário" autocomplete="username">
        </div>
        <div>
          <label class="block text-sm mb-1">Senha</label>
          <input id="authPass" type="password" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2" placeholder="senha" autocomplete="current-password">
        </div>
        <button id="authBtn" type="submit" class="w-full bg-blue-600 hover:bg-blue-700 py-2 rounded">Entrar</button>
        <p id="authErr" class="text-red-400 text-sm hidden">Usuário ou senha incorretos.</p>
      </form>
    </div>
  </div>

  <!-- Header -->
  <header class="bg-gray-800 border-b border-gray-700 p-4 sticky top-0 z-40">
    <div class="flex flex-col gap-2 lg:flex-row lg:justify-between lg:items-center max-w-7xl mx-auto">
      <div class="flex items-center gap-4">
        <img src="https://upload.wikimedia.org/wikipedia/commons/3/34/Logo_PMESP.png" alt="PMESP" class="w-12 h-12 object-contain rounded-md bg-white/5 p-1">
        <div>
          <h1 class="text-lg lg:text-xl font-bold">Dashboard Programa de Policiamento com Drones</h1>
          <p class="text-gray-400 text-xs lg:text-sm">Monitoramento em Tempo Real • YouTube Autoplay</p>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <button id="btnFullscreen" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg text-sm">Tela Cheia</button>
        <button id="btnShare" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg text-sm">Gerar Link</button>
        <button id="btnExport" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg text-sm">Exportar config</button>
        <button id="btnConfig" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg text-sm"
                onclick="document.getElementById('configModal').classList.remove('hidden')">
          Inserir Equipe
        </button>
      </div>
    </div>

    <!-- Controles -->
    <div class="mt-3 max-w-7xl mx-auto">
      <div class="flex flex-wrap items-center gap-2">
        <label class="text-xs text-gray-400">Layout</label>
        <select id="layout" class="bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm">
          <option value="2">2 colunas</option>
          <option value="3">3 colunas</option>
          <option value="4">4 colunas</option>
          <option value="5">5 colunas</option>
        </select>
        <input id="labels" class="flex-1 min-w-[220px] bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm" placeholder="Rótulos (vírgula)" />
        <input id="ids" class="flex-1 min-w-[220px] bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm" placeholder="IDs do YouTube (vírgula)" />
        <button id="apply" class="bg-blue-600 hover:bg-blue-700 px-3 py-1.5 rounded text-sm">Aplicar</button>
        <button id="clear" class="bg-gray-700 hover:bg-gray-600 px-3 py-1.5 rounded text-sm">Limpar</button>
      </div>
      <p id="helperText" class="text-[11px] text-gray-400 mt-1">
        IDs são o que vem após <code>watch?v=</code>. Ex.: <em>https://youtube.com/watch?v=<b>abc123</b></em>
      </p>
    </div>
  </header>

  <!-- Grid -->
  <main class="p-4 max-w-7xl mx-auto">
    <div id="gridContainer" class="grid-container"></div>
  </main>

  <!-- Modal Inserir -->
  <div id="configModal" class="fixed inset-0 bg-black/60 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="bg-gray-800 rounded-lg p-6 w-full max-w-md">
        <h3 class="text-lg font-semibold mb-4 text-center">Inserir Equipe</h3>
        <form id="teamForm" class="space-y-4">
          <div>
            <label class="block text-sm mb-1">Nome da Equipe</label>
            <input id="teamName" type="text" required class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white" placeholder="Ex.: Equipe Alfa">
          </div>
          <div>
            <label class="block text-sm mb-1">Endereço da Operação</label>
            <input id="teamLocation" type="text" required class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white" placeholder="Rua / Bairro / Ponto de referência">
          </div>
          <div>
            <label class="block text-sm mb-1">URL do YouTube</label>
            <input id="youtubeUrl" type="url" required class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white" placeholder="https://www.youtube.com/watch?v=abc123">
          </div>
          <div class="flex gap-3 pt-2">
            <button id="btnAddTeam" class="flex-1 bg-blue-600 hover:bg-blue-700 py-2 rounded">Adicionar</button>
            <button type="button" class="flex-1 bg-gray-600 hover:bg-gray-700 py-2 rounded"
              onclick="document.getElementById('configModal').classList.add('hidden'); document.getElementById('teamForm').reset();">
              Cancelar
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</body>
</html>
